<!DOCTYPE html>
<html>
  <head>
    <title>Test</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <style type="text/css">@import "../styles/reset.css";</style>
    <style type="text/css">
     .main { 
       border: 1px solid #000;
       padding: 10px;
       width: 500px;
       height: 400px;
       overflow: auto;
     }
     .row { 
     }
     .cell {
       border-bottom: 1px solid #999;
       border-right: 1px dotted #999;
       padding: 2px;
       width: 60px;
       display: inline-block;
     }
     .selected {
       background-color: #900;
       color: #fff;
     }
    </style>
    <script type="text/javascript" src="../js/lib/jquery/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="../js/lib/underscore/underscore.1.4.4.js"></script>    
    <script type="text/javascript" src="../js/lib/backbone/backbone-dev.1.0.0.js"></script>
    <script type="text/javascript">
      
    // -----------------------------------------------------------------------
    rows = 200;
    cols = 20;
    
    // -----------------------------------------------------------------------
    View = Backbone.View.extend({
      views: null,
      initialize: function() {
        this.views = [];
      },
      _ensureElement: function() {
        this.el = document.createElement(this.tagName);
        this.el.className = this.className;
        this.setElement(this.el, false);
      },
      addView: function(view) {
        this.views.push(view);
        this.el.appendChild(view.el);
      },
      pluck: function() {
        var el = this.el
          , parent = el.parentNode
          , next = el.nextSibling;
        parent.removeChild(el);
        return function() {
          next ? parent.insertBefore(el, next) : parent.appendChild(el);
        };
      }
    });
    
    // -----------------------------------------------------------------------
    function row() {
      var row = new View({ className: 'row', tagName: 'tr' });
      for (var x = 0; x < cols; x++) {
        var view = new View({ className: 'cell', tagName: 'td' });
        view.el.appendChild(document.createTextNode(x));
        row.addView(view);
      }
      return row;
    }
    
    // -----------------------------------------------------------------------
    function render() {
      console.time('render_time');   
      
      table = new View({ tagName: 'table' });
      for (var x = 0; x < rows; x++) {
        table.addView(row(x));
      }
      $('body')[0].appendChild(table.el);
      
      console.timeEnd('render_time');
    }

    // -----------------------------------------------------------------------
    function update() {
      var rval, cval, cell, frag, span, finish;
      
      console.time('change_time');      
      
      //finish = table.pluck();
      
      for (var i = 0; i < 100; i++) {
        rval = Math.floor(Math.random() * rows);
        cval = Math.floor(Math.random() * cols);
        cell = table.views[rval].views[cval];

        //finish = cell.pluck();

        cell.$el[0].className = 'cell selected';
        
        //frag = document.createDocumentFragment();
        span = document.createElement('span');
        span.innerHTML = 'a';
        cell.el.appendChild(span);
        span = document.createElement('span');
        span.innerHTML = 'b';
        cell.el.appendChild(span);
        span = document.createElement('span');
        span.innerHTML = 'c';
        cell.el.appendChild(span);
        //cell.el.appendChild(frag);
        
        //cell.$el.height();
        
        //cell.$el.html('<span>a</span><span>b</span><span>c</span>');
        //cell.$el.append('<span>a</span>');
        //cell.$el.append('<span>b</span>');
        //cell.$el.append('<span>c</span>');
        
        //finish();
      }

      //finish();
      
      console.timeEnd('change_time');
    }

    // -----------------------------------------------------------------------
    $(document).ready(function() {
      render();
      //setInterval(update, 1000);
    });
    </script>
  </head>
  <body>
  </body>
</html>
